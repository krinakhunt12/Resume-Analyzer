<div class="app-root">
  <!-- Top Navigation -->
  <nav class="main-nav">
    <div class="nav-brand" (click)="currentStep.set(1); results.set(null)">
      <span>üìÑ</span> Resume Analyzer Pro
    </div>
    <ul class="nav-links">
      <li><a href="#" [class.active]="currentStep() === 1 || currentStep() === 2 || currentStep() === 3"
          (click)="currentStep.set(1)">New Analysis</a></li>
      <li><a href="#" [class.active]="currentStep() === 5" (click)="currentStep.set(5)">History</a></li>
    </ul>
    <div class="nav-user" (click)="toggleTheme()">
      {{ isDarkMode() ? 'üåô' : '‚òÄÔ∏è' }}
    </div>
  </nav>

  <div class="app-layout">
    <!-- Hero / Progress -->
    <header class="hero" *ngIf="currentStep() !== 5">
      <div class="stepper">
        <div class="step" [class.completed]="currentStep() > 1" [class.active]="currentStep() === 1">
          <div class="step-circle">1</div>
          <span class="step-label">Upload</span>
        </div>
        <div class="step" [class.completed]="currentStep() > 2" [class.active]="currentStep() === 2">
          <div class="step-circle">2</div>
          <span class="step-label">Processing</span>
        </div>
        <div class="step" [class.completed]="currentStep() > 3" [class.active]="currentStep() === 3">
          <div class="step-circle">3</div>
          <span class="step-label">Insights</span>
        </div>
      </div>
      <h1 *ngIf="currentStep() === 1">Optimize your career trajectory.</h1>
      <p *ngIf="currentStep() === 1">Upload your resume to receive an enterprise-grade ATS analysis and actionable
        growth insights.</p>
    </header>

    <main>
      <!-- STEP 1: UPLOAD FLOW -->
      <section *ngIf="currentStep() === 1">
        <div class="card">
          <h3 class="section-title"><span class="section-icon">üìé</span> Resume Document</h3>
          <div class="upload-container" (click)="fileInput.click()" (dragover)="$event.preventDefault()"
            (drop)="onFileChange($event, 'resume')">
            <div class="upload-content">
              <div class="upload-icon">üì§</div>
              <h3>{{ resumeFile() ? resumeFileName() : 'Click to upload or drag & drop' }}</h3>
              <p>PDF, DOCX supported ‚Ä¢ Max 16MB</p>
            </div>
            <input #fileInput type="file" (change)="onFileChange($event, 'resume')" accept=".pdf,.docx"
              style="display: none">
          </div>

          <!-- Collapsible JD -->
          <div style="margin-top: 3rem; border-top: 1px solid var(--border-main); padding-top: 2rem;">
            <div (click)="showJd.set(!showJd())" class="collapsible-trigger">
              <span>Target Job Description (Optional)</span>
              <span>{{ showJd() ? '‚àí' : '+' }}</span>
            </div>
            <div *ngIf="showJd()" style="margin-top: 1.25rem; animation: slideUp 0.3s ease-out;">
              <textarea class="jd-textarea"
                placeholder="Paste the job description text here for deep keyword matching..."
                [(ngModel)]="tempJdText"></textarea>
            </div>
          </div>
        </div>

        <div style="text-align: center; margin-top: 3rem;">
          <button class="btn btn-primary" style="min-width: 280px;" (click)="onSubmit($event)"
            [disabled]="!resumeFile() || isLoading()">
            {{ isLoading() ? 'Analyzing...' : 'Analyze Resume' }}
          </button>
        </div>
      </section>

      <!-- STEP 2: LOADING -->
      <section *ngIf="isLoading()" class="loading-wrapper">
        <div class="spinner"></div>
        <h3 style="font-weight: 700; font-family: 'Poppins'; font-size: 1.5rem; margin-bottom: 0.5rem;">Processing
          Intelligence</h3>
        <p style="color: var(--primary); font-weight: 600; font-size: 1.1rem; min-height: 1.6rem;">{{ loadingStage() }}
        </p>
        <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 1rem;">This may take up to 30 seconds for
          deep semantic analysis.</p>
      </section>

      <!-- STEP 3: RESULTS DASHBOARD -->
      <section *ngIf="currentStep() === 3 && results()">
        <!-- Summary Card -->
        <div class="card summary-header">
          <div>
            <h2 class="candidate-name">{{ results().candidate_name || 'Candidate Results' }}</h2>
            <p class="candidate-meta">Professional Audit ‚Ä¢ {{ recruiterInsights().candidate_details.email }}</p>
          </div>
          <div [className]="getRatingClass(results().rating)" class="tag"
            style="padding: 0.75rem 1.5rem; font-weight: 700; font-size: 1rem;">
            {{ results().rating }} Match
          </div>
        </div>

        <!-- RECRUITER INSIGHTS: PROFILE CARD -->
        <div class="card" *ngIf="recruiterInsights()">
          <h3 class="section-title"><span class="section-icon">üë§</span> Professional Profile</h3>
          <div class="profile-grid">
            <div>
              <label class="profile-label">Experience Tenure</label>
              <p class="profile-value-highlight">{{ recruiterInsights().candidate_details.total_years_experience }}
                Years</p>
            </div>
            <div>
              <label class="profile-label">Recent Titles</label>
              <p class="profile-value">{{ recruiterInsights().key_sections.work_experience_summary }}</p>
            </div>
            <div *ngIf="recruiterInsights().key_sections.education.length">
              <label class="profile-label">Top Education</label>
              <p class="profile-value">{{ recruiterInsights().key_sections.education[0] }}</p>
            </div>
          </div>
        </div>

        <div class="results-grid">
          <div class="left-col">
            <!-- TIMELINE VISUALIZATION -->
            <div class="card" *ngIf="recruiterInsights()?.timeline">
              <h3 class="section-title"><span class="section-icon">üìÖ</span> Experience Journey</h3>
              <div class="timeline-track">
                <div class="timeline-event" *ngFor="let event of getSortedTimeline()">
                  <div class="timeline-dot"></div>
                  <div class="event-content">
                    <div class="event-date">{{ event.year }} ({{ event.duration }})</div>
                    <div class="event-role">{{ event.role }}</div>
                    <div class="event-company">{{ event.company }}</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Skills Breakdown -->
            <div class="card">
              <h3 class="section-title"><span class="section-icon">üõ†Ô∏è</span> Skills Taxonomy</h3>
              <div style="margin-bottom: 2.5rem;">
                <label class="skill-category-label">Technical Proficiencies</label>
                <div class="tags">
                  <span class="tag" *ngFor="let s of recruiterInsights().key_sections.skills.technical">{{ s }}</span>
                </div>
              </div>

              <div style="margin-bottom: 2.5rem;">
                <label class="skill-category-label">Professional Competencies</label>
                <div class="tags">
                  <span class="tag" *ngFor="let s of recruiterInsights().key_sections.skills.soft_skills">{{ s }}</span>
                </div>
              </div>

              <!-- KEYWORD GAP ANALYSIS (New Feature) -->
              <div class="card" *ngIf="results().keyword_match?.missing_keywords?.length > 0">
                <h3 class="section-title"><span class="section-icon"
                    style="background: var(--warning-soft); color: var(--warning)">‚ö†Ô∏è</span> Keyword Gap Analysis</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.95rem;">
                  Your resume is missing these high-value keywords found in the job description. Adding them can boost
                  your ATS score significantly.
                </p>
                <div class="tags">
                  <span class="tag tag-danger" *ngFor="let k of results().keyword_match.missing_keywords"
                    style="cursor: pointer; opacity: 0.8;">
                    + {{ k }}
                  </span>
                </div>
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-main);">
                  <label class="skill-category-label">Matched Keywords</label>
                  <div class="tags">
                    <span class="tag tag-success" *ngFor="let k of results().keyword_match.matching_keywords">
                      ‚úì {{ k }}
                    </span>
                  </div>
                </div>
              </div>

              <!-- SKILL HEATMAP VISUALIZATION -->
              <div style="margin-top: 3rem; border-top: 1px solid var(--border-main); padding-top: 2rem;">
                <label class="skill-category-label">Skill Density Map</label>
                <div class="heatmap-container">
                  <div class="heatmap-square lv{{ getSkillLevel(recruiterInsights().skill_heatmap.technical) }}"
                    title="Technical Skills"></div>
                  <div class="heatmap-square lv{{ getSkillLevel(recruiterInsights().skill_heatmap.tools) }}"
                    title="Tools"></div>
                  <div class="heatmap-square lv{{ getSkillLevel(recruiterInsights().skill_heatmap.soft) }}"
                    title="Soft Skills"></div>
                  <div class="heatmap-square lv1"></div>
                  <div class="heatmap-square lv2"></div>
                  <div class="heatmap-square lv1"></div>
                  <div class="heatmap-square lv4"></div>
                  <div class="heatmap-square lv2"></div>
                </div>
                <div class="heatmap-legend">
                  <span>Sparse</span>
                  <div class="legend-box lv1" style="background: var(--primary-soft)"></div>
                  <div class="legend-box lv2" style="background: var(--primary-light)"></div>
                  <div class="legend-box lv3" style="background: var(--primary)"></div>
                  <div class="legend-box lv4" style="background: var(--primary-hover)"></div>
                  <span>Dense</span>
                </div>
              </div>
            </div>

            <!-- LinkedIn Profile Audit -->
            <div class="card">
              <h3 class="section-title"><span class="section-icon">üîó</span> LinkedIn Strategy</h3>
              <p style="font-size: 1rem; color: var(--text-secondary); margin-bottom: 1.5rem;">Paste your LinkedIn
                'About' section below to analyze its impact.</p>
              <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                <textarea class="linkedin-audit-textarea" placeholder="Paste LinkedIn content here..."
                  [ngModel]="linkedInUrl()" (ngModelChange)="linkedInUrl.set($event)"></textarea>
              </div>
              <button class="btn btn-secondary" (click)="analyzeLinkedIn()" style="width: 100%;">Analyze Profile
                Strength</button>

              <div *ngIf="linkedInResult()" class="status-card"
                style="margin-top: 2rem; border-left: 4px solid var(--primary); padding: 1.5rem;">
                <div style="font-weight: 700; color: var(--text-primary); font-size: 1.2rem;">Social Score: {{
                  linkedInResult().overall_score }}/100</div>
                <p style="font-size: 1rem; color: var(--text-secondary); margin-top: 0.5rem;">{{
                  linkedInResult().headline_strength }} Headline ‚Ä¢ {{ linkedInResult().about_section }} Summary</p>
                <ul
                  style="margin-top: 1rem; padding-left: 1.25rem; font-size: 0.95rem; color: var(--text-secondary); display: flex; flex-direction: column; gap: 0.5rem;">
                  <li *ngFor="let rec of linkedInResult().recommendations">{{ rec }}</li>
                </ul>
              </div>
            </div>

            <!-- Strengths & Improvements -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
              <div>
                <h3 class="section-title" style="color: var(--accent);"><span class="section-icon"
                    style="background: var(--accent-soft); color: var(--accent)">‚úîÔ∏è</span> Strengths</h3>
                <div class="status-card" *ngFor="let s of recruiterInsights().resume_quality.strengths">
                  <p style="font-size: 0.95rem; color: var(--text-secondary);">{{ s }}</p>
                </div>
              </div>
              <div>
                <h3 class="section-title" style="color: var(--danger);"><span class="section-icon"
                    style="background: var(--danger-soft); color: var(--danger)">‚ö†Ô∏è</span> Improvements</h3>
                <div class="status-card"
                  *ngFor="let s of recruiterInsights().improvement_suggestions.content_improvements">
                  <p style="font-size: 0.95rem; color: var(--text-secondary);">{{ s }}</p>
                </div>
              </div>
            </div>
          </div>

          <div class="right-col">
            <!-- ATS Score Card -->
            <div class="card">
              <h3 class="section-title"><span class="section-icon">üìä</span> ATS Integrity</h3>
              <div class="score-visual">
                <div class="score-circle">
                  <span class="score-number">{{ results().overall_score | number:'1.0-0' }}</span>
                  <span class="score-label">Points</span>
                </div>
              </div>
              <p class="score-description">High-level semantic matching score mimicking enterprise ATS algorithms.</p>

              <div style="margin-top: 2rem; border-top: 1px solid var(--border-main); padding-top: 1.5rem;">
                <h4
                  style="font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; letter-spacing: 0.08em; margin-bottom: 1.25rem;">
                  Detailed Breakdown</h4>
                <div *ngFor="let key of getScoreKeys(results())" class="score-metric" style="margin-bottom: 1rem;">
                  <div
                    style="display: flex; justify-content: space-between; font-size: 0.95rem; margin-bottom: 0.4rem;">
                    <span style="color: var(--text-secondary); text-transform: capitalize; font-weight: 500;">{{
                      key.replace('_', ' ') }}</span>
                    <span style="font-weight: 700; color: var(--text-primary);">{{ results()[key] }}%</span>
                  </div>
                  <div
                    style="height: 8px; background: var(--bg-surface); border-radius: 4px; overflow: hidden; border: 1px solid var(--border-main);">
                    <div [style.width.%]="results()[key]"
                      [style.background-color]="results()[key] > 75 ? 'var(--primary)' : (results()[key] > 50 ? 'var(--accent)' : 'var(--danger)')"
                      style="height: 100%; border-radius: 4px; transition: width 1s ease-out;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Career Roadmap Summary -->
            <div class="card" *ngIf="results().career_roadmap" style="margin-top: 2rem;">
              <h3 class="section-title"><span class="section-icon">üöÄ</span> Next Horizon</h3>
              <p class="roadmap-target">{{ results().career_roadmap.target_next_level }}</p>
              <ul class="roadmap-steps">
                <li *ngFor="let step of results().career_roadmap.steps.slice(0, 3)" class="roadmap-step">
                  <span>‚Ä¢</span> {{ step }}
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Download Report Card -->
        <div class="card download-card" style="margin-top: 4rem;">
          <div class="download-info">
            <h3>Ready for Submission</h3>
            <p>Export your verified professional report. Formatted for standard A4 printing.</p>
            <div
              style="display: flex; gap: 1rem; margin-top: 0.75rem; font-size: 0.85rem; color: var(--text-muted); font-weight: 500;">
              <span>‚Ä¢ PDF Format</span>
              <span>‚Ä¢ ATS Verified</span>
              <span>‚Ä¢ <a href="#" (click)="$event.preventDefault(); printPage()"
                  style="color: var(--primary); text-decoration: none; cursor: pointer;">Print View</a></span>
            </div>
          </div>
          <button class="btn btn-primary" (click)="downloadReport()" [disabled]="isPdfLoading()">
            <span>‚¨áÔ∏è</span> {{ isPdfLoading() ? 'Generating...' : 'Download Report' }}
          </button>
        </div>
      </section>

      <!-- STEP 5: HISTORY VIEW -->
      <section *ngIf="currentStep() === 5">
        <div class="card" style="max-width: 800px; margin: 0 auto; min-height: 60vh;">
          <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-main);">
            <h2 class="section-title" style="margin-bottom: 0;">Analysis History</h2>
            <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;" (click)="clearHistory()"
              *ngIf="historyList().length > 0">Clear History</button>
          </div>

          <div *ngIf="historyList().length === 0"
            style="text-align: center; padding: 4rem 0; color: var(--text-muted);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
            <p>No analysis history found.</p>
            <button class="btn btn-primary" style="margin-top: 1.5rem;" (click)="currentStep.set(1)">Start New
              Analysis</button>
          </div>

          <div class="history-list">
            <div class="history-item" *ngFor="let item of historyList()" (click)="selectHistory(item)">
              <div>
                <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-primary); margin-bottom: 0.25rem;">{{
                  item.fileName }}</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">{{ item.date | date:'medium' }} ‚Ä¢ {{
                  item.candidate }}</div>
              </div>
              <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="font-weight: 800; font-size: 1.5rem; color: var(--primary);">{{ item.score | number:'1.0-0'
                  }}%</div>
                <button class="btn btn-secondary" style="padding: 0.5rem;"
                  (click)="deleteHistory(item.id, $event)">‚úï</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Chat Widget -->
    <button class="chat-btn" (click)="toggleChat()">üí¨</button>

    <div *ngIf="isChatOpen()" class="chat-widget-card">
      <div class="chat-header">
        <span>AI Career Assistant</span>
        <span (click)="toggleChat()" style="cursor: pointer; font-size: 1.5rem;">&times;</span>
      </div>
      <div class="chat-message-container">
        <div *ngFor="let m of chatMessages()" class="chat-message" [class.chat-message-user]="m.role === 'user'"
          [class.chat-message-ai]="m.role !== 'user'">
          {{ m.text }}
        </div>
      </div>
      <div class="chat-input-area">
        <input type="text" [(ngModel)]="tempChatInput" (keyup.enter)="sendMessage()"
          placeholder="Ask about your resume..." class="chat-input-field">
        <button class="chat-send-btn" (click)="sendMessage()">Send</button>
      </div>
    </div>
  </div>
</div>
<div class="app-root">
  <!-- Top Navigation -->
  <nav class="main-nav">
    <div class="nav-brand" (click)="currentStep.set(1); results.set(null)">
      <span>üìÑ</span> Resume Analyzer Pro
    </div>
    <ul class="nav-links">
      <li><a href="#" [class.active]="currentStep() === 1" (click)="currentStep.set(1)">Analyzer</a></li>
      <li><a href="#" [class.active]="currentStep() === 4" (click)="currentStep.set(4)">Reports</a></li>
      <li><a href="#" [class.active]="currentStep() === 5" (click)="currentStep.set(5)">History</a></li>
    </ul>
    <div class="nav-user" (click)="toggleTheme()">
      {{ isDarkMode() ? 'üåô' : '‚òÄÔ∏è' }}
    </div>
  </nav>

  <div class="app-layout">
    <!-- Hero / Progress -->
    <header class="hero">
      <div class="stepper">
        <div class="step" [class.completed]="currentStep() > 1" [class.active]="currentStep() === 1">
          <div class="step-circle">1</div>
          <span class="step-label">Upload</span>
        </div>
        <div class="step" [class.completed]="currentStep() > 2" [class.active]="currentStep() === 2">
          <div class="step-circle">2</div>
          <span class="step-label">Analyze</span>
        </div>
        <div class="step" [class.completed]="currentStep() > 3" [class.active]="currentStep() === 3">
          <div class="step-circle">3</div>
          <span class="step-label">Insights</span>
        </div>
      </div>
      <h1 *ngIf="currentStep() === 1">Optimize your career path.</h1>
      <p *ngIf="currentStep() === 1">Upload your resume to receive an enterprise-grade ATS analysis and actionable
        growth insights.</p>
    </header>

    <main>
      <!-- STEP 1: UPLOAD FLOW -->
      <section *ngIf="currentStep() === 1">
        <div class="card">
          <h3 class="section-title"><span>üìé</span> Resume Document</h3>
          <div class="upload-container" (click)="fileInput.click()" (dragover)="$event.preventDefault()"
            (drop)="onFileChange($event, 'resume')">
            <div class="upload-icon">üì§</div>
            <h3>{{ resumeFile() ? resumeFileName() : 'Click to upload or drag & drop' }}</h3>
            <p>PDF, DOCX supported ‚Ä¢ Max 16MB</p>
            <input #fileInput type="file" (change)="onFileChange($event, 'resume')" accept=".pdf,.docx"
              style="display: none">
          </div>

          <!-- Collapsible JD -->
          <div style="margin-top: 2.5rem; border-top: 1px solid var(--border-main); padding-top: 1.5rem;">
            <div (click)="showJd.set(!showJd())" class="collapsible-trigger">
              <span>Target Job Description (Optional)</span>
              <span>{{ showJd() ? '‚àí' : '+' }}</span>
            </div>
            <div *ngIf="showJd()" style="margin-top: 1.25rem;">
              <textarea class="jd-textarea"
                placeholder="Paste the job description text here for deep keyword matching..."
                [(ngModel)]="tempJdText"></textarea>
            </div>
          </div>
        </div>

        <div style="text-align: center; margin-top: 3rem;">
          <button class="btn btn-primary" style="min-width: 260px;" (click)="onSubmit($event)"
            [disabled]="!resumeFile() || isLoading()">
            Analyze Resume
          </button>
        </div>
      </section>

      <!-- STEP 2: LOADING -->
      <section *ngIf="isLoading()" class="loading-wrapper">
        <div class="spinner"></div>
        <h3 style="font-weight: 600; font-family: 'Poppins';">Processing Intelligence</h3>
        <p style="color: var(--text-secondary); margin-top: 0.75rem; font-size: 1.1rem;">Running semantic analysis and
          scanning for ATS patterns...</p>
      </section>

      <!-- STEP 3: RESULTS DASHBOARD -->
      <section *ngIf="currentStep() === 3 && results()">
        <!-- Summary Card -->
        <div class="card summary-header">
          <div>
            <h2 class="candidate-name">{{ results().candidate_name || 'Candidate Results' }}</h2>
            <p class="candidate-meta">Professional Audit ‚Ä¢ {{ recruiterInsights().candidate_details.email }}</p>
          </div>
          <div [className]="getRatingClass(results().rating)" class="tag"
            style="padding: 0.5rem 1.25rem; font-weight: 700;">
            {{ results().rating }} Match
          </div>
        </div>

        <!-- RECRUITER INSIGHTS: PROFILE CARD -->
        <div class="card" *ngIf="recruiterInsights()">
          <h3 class="section-title"><span>üë§</span> Professional Profile</h3>
          <div class="profile-grid">
            <div>
              <label class="profile-label">Experience Tenure</label>
              <p class="profile-value-highlight">{{ recruiterInsights().candidate_details.total_years_experience }}
                Years</p>
            </div>
            <div>
              <label class="profile-label">Recent Titles</label>
              <p class="profile-value">{{ recruiterInsights().key_sections.work_experience_summary }}</p>
            </div>
            <div *ngIf="recruiterInsights().key_sections.education.length">
              <label class="profile-label">Top Education</label>
              <p class="profile-value">{{ recruiterInsights().key_sections.education[0] }}</p>
            </div>
          </div>
        </div>

        <div class="results-grid">
          <div class="left-col">
            <!-- TIMELINE VISUALIZATION -->
            <div class="card" *ngIf="recruiterInsights()?.timeline">
              <h3 class="section-title"><span>üìÖ</span> Experience Journey</h3>
              <div class="timeline-track">
                <div class="timeline-event" *ngFor="let event of getSortedTimeline()">
                  <div class="timeline-dot"></div>
                  <div class="event-content">
                    <div class="event-date">{{ event.year }} ({{ event.duration }})</div>
                    <div class="event-role">{{ event.role }}</div>
                    <div class="event-company">{{ event.company }}</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Skills Breakdown -->
            <div class="card">
              <h3 class="section-title"><span>üõ†Ô∏è</span> Skills Taxonomy</h3>
              <div style="margin-bottom: 2rem;">
                <label class="skill-category-label">Technical Proficiencies</label>
                <div class="tags">
                  <span class="tag" *ngFor="let s of recruiterInsights().key_sections.skills.technical">{{ s }}</span>
                </div>
              </div>

              <div style="margin-bottom: 2rem;">
                <label class="skill-category-label">Professional Competencies</label>
                <div class="tags">
                  <span class="tag" *ngFor="let s of recruiterInsights().key_sections.skills.soft_skills">{{ s }}</span>
                </div>
              </div>

              <!-- SKILL HEATMAP VISUALIZATION -->
              <div style="margin-top: 2.5rem; border-top: 1px solid var(--border-main); padding-top: 1.5rem;">
                <label class="skill-category-label">Skill Density Map</label>
                <div class="heatmap-container">
                  <div class="heatmap-square lv{{ getSkillLevel(recruiterInsights().skill_heatmap.technical) }}"></div>
                  <div class="heatmap-square lv{{ getSkillLevel(recruiterInsights().skill_heatmap.tools) }}"></div>
                  <div class="heatmap-square lv{{ getSkillLevel(recruiterInsights().skill_heatmap.soft) }}"></div>
                  <div class="heatmap-square lv1"></div>
                  <div class="heatmap-square lv2"></div>
                  <div class="heatmap-square lv1"></div>
                  <div class="heatmap-square lv4"></div>
                  <div class="heatmap-square lv2"></div>
                </div>
                <div class="heatmap-legend">
                  <span>Sparse</span>
                  <div class="legend-box lv1"></div>
                  <div class="legend-box lv2"></div>
                  <div class="legend-box lv3"></div>
                  <div class="legend-box lv4"></div>
                  <span>Dense</span>
                </div>
              </div>
            </div>

            <!-- LinkedIn Profile Audit -->
            <div class="card">
              <h3 class="section-title"><span>üîó</span> LinkedIn Profile Strategy</h3>
              <p style="font-size: 0.95rem; color: var(--text-secondary); margin-bottom: 1.5rem;">Enhance your social
                presence by auditing your profile content.</p>
              <div style="display: flex; gap: 0.75rem; margin-bottom: 1.5rem;">
                <textarea class="linkedin-audit-textarea" placeholder="Paste LinkedIn 'About' or 'Experience' text..."
                  [ngModel]="linkedInUrl()" (ngModelChange)="linkedInUrl.set($event)"></textarea>
              </div>
              <button class="btn btn-secondary" (click)="analyzeLinkedIn()" style="width: 100%;">Analyze Profile
                Strength</button>

              <div *ngIf="linkedInResult()" class="status-card"
                style="margin-top: 2rem; border-left: 4px solid var(--primary); padding: 1.5rem;">
                <div style="font-weight: 700; color: var(--text-primary); font-size: 1.1rem;">Social Score: {{
                  linkedInResult().overall_score }}/100</div>
                <p style="font-size: 0.95rem; color: var(--text-secondary); margin-top: 0.5rem;">{{
                  linkedInResult().headline_strength }} Headline ‚Ä¢ {{ linkedInResult().about_section }} Summary</p>
                <ul
                  style="margin-top: 1rem; padding-left: 1.25rem; font-size: 0.9rem; color: var(--text-secondary); display: flex; flex-direction: column; gap: 0.5rem;">
                  <li *ngFor="let rec of linkedInResult().recommendations">{{ rec }}</li>
                </ul>
              </div>
            </div>

            <!-- Strengths & Improvements -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
              <div>
                <h3 class="section-title" style="color: var(--accent);"><span>‚úîÔ∏è</span> Strengths</h3>
                <div class="status-card" *ngFor="let s of recruiterInsights().resume_quality.strengths">
                  <p style="font-size: 0.95rem; color: var(--text-secondary);">{{ s }}</p>
                </div>
              </div>
              <div>
                <h3 class="section-title" style="color: var(--danger);"><span>‚ö†Ô∏è</span> Improvements</h3>
                <div class="status-card"
                  *ngFor="let s of recruiterInsights().improvement_suggestions.content_improvements">
                  <p style="font-size: 0.95rem; color: var(--text-secondary);">{{ s }}</p>
                </div>
              </div>
            </div>
          </div>

          <div class="right-col">
            <!-- ATS Score Card -->
            <div class="card" style="border-top: 4px solid var(--text-primary);">
              <h3 class="section-title"><span>üìä</span> ATS Integrity</h3>
              <div class="score-visual">
                <div class="score-circle">
                  <span class="score-number">{{ results().overall_score | number:'1.0-0' }}</span>
                  <span class="score-label">Points</span>
                </div>
                <p class="score-description">High-level semantic matching indicator for automated recruiter systems.</p>
              </div>
            </div>

            <!-- Career Roadmap Summary -->
            <div class="card" *ngIf="results().career_roadmap">
              <h3 class="section-title"><span>üöÄ</span> Next Horizon</h3>
              <p class="roadmap-target">{{ results().career_roadmap.target_next_level }}</p>
              <ul class="roadmap-steps">
                <li *ngFor="let step of results().career_roadmap.steps.slice(0, 3)" class="roadmap-step">
                  <span>‚Ä¢</span> {{ step }}
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Download Report Card -->
        <div class="card download-card" style="margin-top: 4rem;">
          <div class="download-info">
            <h3>Ready for Submission</h3>
            <p>Export your verified professional report for recruiter outreach.</p>
          </div>
          <button class="btn btn-primary" (click)="downloadReport()" [disabled]="isPdfLoading()">
            <span>‚¨áÔ∏è</span> {{ isPdfLoading() ? 'Generating...' : 'Download Report' }}
          </button>
        </div>
      </section>

      <!-- STEP 4: REPORTS VIEW -->
      <section *ngIf="currentStep() === 4">
        <div class="card" style="text-align: center; padding: 6rem 2rem;">
          <h1 style="margin-bottom: 1.5rem;">Report Repository</h1>
          <p style="color: var(--text-secondary); margin-bottom: 3rem; font-size: 1.1rem;">Access and manage your
            generated analysis reports in one place.</p>
          <div
            style="max-width: 500px; margin: 0 auto; padding: 3rem; border: 20px dashed var(--border-main); border-radius: var(--radius-lg); color: var(--text-muted);">
            <p>No reports found in this session.</p>
          </div>
          <button class="btn btn-primary" style="margin-top: 3rem;" (click)="currentStep.set(1)">New Analysis</button>
        </div>
      </section>

      <!-- STEP 5: HISTORY VIEW -->
      <section *ngIf="currentStep() === 5">
        <div class="card" style="text-align: center; padding: 6rem 2rem;">
          <h1 style="margin-bottom: 1.5rem;">Analysis History</h1>
          <p style="color: var(--text-secondary); margin-bottom: 3rem; font-size: 1.1rem;">Review your past scans and
            optimization progress.</p>
          <div style="max-width: 650px; margin: 0 auto;">
            <div class="status-card"
              style="display: flex; justify-content: space-between; align-items: center; padding: 2rem;">
              <div style="text-align: left;">
                <div style="font-weight: 700; font-size: 1.1rem;">{{ resumeFileName() || 'Untitled Session' }}</div>
                <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 0.25rem;">Active Analysis Session ‚Ä¢
                  Today</div>
              </div>
              <div *ngIf="results()" style="font-weight: 800; color: var(--text-primary); font-size: 1.5rem;">
                {{ results().overall_score | number:'1.0-0' }}%
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Chat Widget -->
    <button class="chat-btn" (click)="toggleChat()">üí¨</button>

    <div *ngIf="isChatOpen()" class="chat-widget-card">
      <div class="chat-header">
        <span>AI Career Assistant</span>
        <span (click)="toggleChat()" style="cursor: pointer; font-size: 1.5rem;">&times;</span>
      </div>
      <div class="chat-message-container">
        <div *ngFor="let m of chatMessages()" class="chat-message" [class.chat-message-user]="m.role === 'user'"
          [class.chat-message-ai]="m.role !== 'user'">
          {{ m.text }}
        </div>
      </div>
      <div class="chat-input-area">
        <input type="text" [(ngModel)]="tempChatInput" (keyup.enter)="sendMessage()"
          placeholder="Ask about your resume..." class="chat-input-field">
        <button class="chat-send-btn" (click)="sendMessage()">Send</button>
      </div>
    </div>
  </div>
</div>